import Now from '~/components/now/now'
import Card from '~/components/card'
import Example from '~/components/api/example'
import { Code } from '~/components/text/code'
import { P, PDIV } from '~/components/text/paragraph'
import { GenericLink } from '~/components/text/link'
import Note from '~/components/text/note'

export const meta = {
  title: 'Deployment Configuration (now.json)',
  description: 'Configuring Now so that your deployments are exactly as you need them.'
}

## Configuration

When using [Now CLI](/docs/v2/getting-started/installation#now-cli), [Now Desktop](/docs/v2/getting-started/installation#now-desktop) or [Now for GitHub](/docs/v2/getting-started/installation#now-for-github), the configuration for your deployment is read from the `now.json` file.

The parameters stored in that file are passed to the [Deployment Creation API endpoint](/docs/api/v2#endpoints/deployments/create-a-new-deployment), which performs validation and stores the metadata in our backend.

### Schemas
If you are looking for a strict or machine-friendly specification of the configuration, we recommend [looking at `zeit/schemas`](https://github.com/zeit/schemas).

### Configuration File
The following sections describe each field allowed in a `now.json` configuration file and how to use them.

Each deployment recieves and understands the `now.json` configuration as instructions of how to build and then act when deployed.

### version
**Type**: `Number`.

**Valid values**: `1`, `2`.

Specifies the [Now Platform version](/docs/v2/platform/overview#versioning) the deployment should use and is known to work with. We strongly recommend setting a `version` when working on production systems or using source control (e.g. [Git](https://git-scm.com)).

<Example>
<P.B>Usage Example:</P.B>
<Code>{`{
  "version": 2
}`}</Code>
</Example>

### alias
**Type**: `Array` or `String`.

**Valid values**: [domain names](/docs/v2/domains-and-aliases/adding-a-domains) (optionally including subdomains) added to the account.

The alias or aliases are applied when merging a PR to the master branch with [Now for GitHub](/docs/v2/integrations/now-for-github), or when deploying to master.

<Example>
<P.B>Usage Example:</P.B>
<Code>{`{
  "alias": ["my-domain.com", "www.my-domain.com"]
}`}</Code>
</Example>

### env
**Type:** `Object` of `String` keys and values.

**Valid values:** environment keys and values.

Environment variables passed to the invoked [Lambdas](/docs/v2/deployments/concepts/lambdas).


<Example>
<P.B>Usage Example:</P.B>
<PDIV>This example will pass the `MY_KEY` static env to all <GenericLink href="/docs/v2/deployments/concepts/lambdas">Lambdas</GenericLink> and `SECRET` resolved from the `my-secret-name` <GenericLink href="/docs/v2/deployments/environment-variables-and-secrets#securing-environment-variables-using-secrets">secret</GenericLink> dynamically.</PDIV>
<Code>{`{
  "env": {
    "MY_KEY": "this is the value",
    "SECRET": "@my-secret-name"
  }
}`}</Code>
</Example>

### build.env

**Type:** `Object` of `String` keys and values inside the `build` `Object`.

**Valid values:** environment keys and values.

Environment variables passed to the [Build](/docs/v2/deployments/builds) processes.

<Example>
<P.B>Usage Example:</P.B>
<PDIV>The following example will pass the `MY_KEY` static env to all <GenericLink href="/docs/v2/deployments/builds">Builds</GenericLink> and `SECRET` resolved from the `my-secret-name` <GenericLink href="/docs/v2/deployments/environment-and-secrets">secret</GenericLink> dynamically.</PDIV>
<Code>{`{
  "build": {
    "env": {
      "MY_KEY": "this is the value",
      "SECRET": "@my-secret-name"
    }
  }
}`}</Code>
</Example>

### builds
**Type:** `Array` of build  `Object`.

**Valid values:** a list of build descriptions whose `src` references valid source files.

**Build object definition:**
- `src` (`String`): A glob expression or pathname. If more than one file is resolved, one build will be created per matched file. It can include `*` and `**`
- `use` (`String`): A npm module to be installed by the [build process](/docs/v2/deployments/builds). It can include a semver compatible version (e.g.: `@org/proj@1`)
- `config` (`Object`): Optionally, an object including arbitrary metadata to be passed to the Builder

<Example>
<P.B>Usage Example:</P.B>
<PDIV>The following will include all HTML files as-is (to be served statically), and <GenericLink href="/docs/v2/deployments/builds">Build</GenericLink> all PHP files and JS files into <GenericLink href="/docs/v2/deployments/concepts/lambdas">Lambdas</GenericLink>.</PDIV>
<Code>{`{
  "builds": [
    { "src": "*.html", "use": "@now/static" },
    { "src": "*.php", "use": "@now/php" },
    { "src": "*.js", "use": "@now/node" },
  ]
}`}</Code>
</Example>

<Note>When at least one `builds` item is specified, only the outputs of the build processes will be included in the resulting deployment as a security precaution. This is why we need to white-list static files explicitly with `@now/static`</Note>

For more information, refer to [Builds](/docs/v2/deployments/builds) and [Builder](/docs/v2/deployments/builders/overview) documentation.

### routes
**Type:** `Array` of route `Object`.

**Valid values:** a list of route definitions.

**Route object definition:**
- `src`: A PCRE-compatible regular expression that matches each incoming pathname (excluding querystring).
- `dest`: A destination pathname or full URL, including querystring, with the ability to embed capture groups as $1, $2â€¦
- `headers`: A set of headers to apply for responses.
- `status`: A status code to respond with. Can be used in tandem with `Location: ` header to implement redirects.

**Example:**

The following example configures custom routes that map to static files and lambdas


<Example>
<P.B>Usage Example:</P.B>
<PDIV>This example configures custom routes that map to static files and <GenericLink href="/docs/v2/deployments/concepts/lambdas">Lambdas</GenericLink>.</PDIV>
<Code>{`{
  "builds": [
    { "src": "*.html", "use": "@now/static" },
    { "src": "*.js", "use": "@now/node" },
  ],
  "routes": [
    { "src": "/custom-page", "headers": {"cache-control": "s-maxage=1000"}, "dest": "index.html" },
    { "src": "/api", "dest": "/my-api.js" },
    { "src": "/users/(?<id>[^/]*)", "dest": "/users-api.js?id=$id" },
    { "src": "/.*", "dest": "https://my-old-site.com"},
    { "src": "/legacy", "status": 404},
    { "src": "/redirect", "status": 301, "headers": { "Location": "https://zeit.co/" } }
  ]
}`}</Code>
</Example>

### regions

**Type:** `Array` of region identifier `String`.

**Valid values:** a list of valid [region identifiers](/docs/v2/platform/regions-and-providers).

By setting and modifying this value, you can decide the deployment **regions** of the [Lambdas](/docs/v2/deployments/concepts/lambdas) that get created as a result of the [build steps](/docs/v2/deployments/builds).

This value does not impact static files or edge caches, since deployments always have a [CDN layer](/docs/v2/domains-and-aliases/cdn) in front.

The special value `all` can be used to target all available regions.

<Note>The values in `regions` support targeting a region generically, by omitting the number. If `sfo` is specified, our backend will select a singular region (like `sfo1`) at deploy time.</Note>

<Example>
<P.B>Usage Example:</P.B>
<Code>{`{
  "regions": ["sfo1", "bru"]
}`}</Code>
</Example>

### public
**Type**: `Boolean`.

When set to `true`, both the [source view](/docs/v2/deployments/concepts/special-paths#source-view) and [logs view](/docs/v2/deployments/concepts/special-paths#logs-view) will be publically accessible (without authentication with ZEIT).

<Example>
<P.B>Usage Example:</P.B>
<Code>{`{
  "public": true
}`}</Code>
</Example>


### github.enabled
**Type**: `Boolean`.

When set to `false`, [Now for GitHub](/docs/v2/integrations/now-for-github) will not deploy the given project regardless of the GitHub app being installed.

<Example>
<P.B>Usage Example:</P.B>
<Code>{`{
  "github": {
    "enabled": false
  }
}`}</Code>
</Example>

### github.autoAlias
**Type**: `Boolean`.

When set to `false`, [Now for GitHub](/docs/v2/integrations/now-for-github) will not apply the alias upon merge.

<Example>
<P.B>Usage Example:</P.B>
<Code>{`{
  "alias": ["my-zeit-website.com"],
  "github": {
    "autoAlias": false
  }
}`}</Code>
</Example>
